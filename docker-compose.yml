version: '3.8'

services:

  api_gateway:
    depends_on:
      - user_service
    build:
      context: ./
      dockerfile: ./api_gateway/Dockerfile
    container_name: api_gateway
    expose:
      - 8080
    ports:
      - '8080:8080'
    networks:
      brewstand-net:
        ipv4_address: 172.100.10.5
    environment:
      - USER_SERVICE_HOST=172.100.10.10
  
  user_controller:
    build:
      context: ./
      dockerfile: ./user_controller/Dockerfile
    container_name: user_controller
    expose:
      - 3000
    ports:
      - '3000:3000'
    networks:
      brewstand-net:
        ipv4_address: 172.100.10.10

  user_service:
    build:
      context: ./
      dockerfile: ./user_service/Dockerfile
    container_name: user_service
    expose:
      - 50051
    ports:
      - '50051:50051'
    networks:
      brewstand-net:
        ipv4_address: 172.100.10.20
  
  user_repository:
    build:
      context: ./
      dockerfile: ./user_repository/Dockerfile
    container_name: user_repository
    expose:
      - 50061
    ports:
      - '50061:50061'
    networks:
      brewstand-net:
        ipv4_address: 172.100.10.30

  user_db:
      image: mongodb/mongodb-community-server:latest
      container_name: user_db
      ports:
        - "27017:27017"
      volumes:
        - ./volumes/user_db:/data/db
      networks:
          brewstand-net:
              ipv4_address: 172.100.10.40

  inventory_db:
    image: postgres:latest
    ports:
      - 5432:5432
    volumes:
      - ./volumes/inventory_db:/var/lib/postgresql/data
    environment:
      - POSTGRES_PASSWORD=VerySecureYesYes123
      - POSTGRES_USER=db_access_inventory
      - POSTGRES_DB=inventory_db
    networks:
      brewstand-net:
        ipv4_address: 172.100.10.34

networks:
  brewstand-net:
      driver: bridge
      ipam:
        driver: default
        config:
          - subnet: 172.100.10.0/24